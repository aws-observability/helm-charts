{{- if .Values.agent.enabled }}
{{- $clusterName := .Values.clusterName | required ".Values.clusterName is required." -}}
{{- $region := .Values.region | required ".Values.region is required." -}}
{{- range $i, $agent := $.Values.agentWorkloadsWindows }}
apiVersion: cloudwatch.aws.amazon.com/v1alpha1
kind: AmazonCloudWatchAgent
metadata:
  labels:
    {{- include "amazon-cloudwatch-observability.labels" $ | nindent 4}}
  name: {{ $agent.name | default (include "cloudwatch-agent.name" $) }}
  namespace: {{ $.Release.Namespace }}
spec:
  {{- with $agent.podSecurityContext }}
  podSecurityContext: {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- if $agent.hostNetwork }}
  hostNetwork: {{ $agent.hostNetwork | default false }}
  {{- end }}
  image: {{ template "cloudwatch-agent.image" $ }}
  {{- if $agent.workingDir }}
  workingDir: {{ $agent.workingDir | quote }}
  {{- end }}
  mode: {{ $agent.mode | default "daemonset" }}
  serviceAccount: {{ template "cloudwatch-agent.serviceAccountName" $ }}
  {{- with $agent.nodeSelector }}
  nodeSelector: {{- toYaml . | nindent 4}}
  {{- end }}
  config: {{ $agent.config | default $.Values.agent.windowsDefaultConfig | toJson | quote }}
  {{- with $.Values.agent.resources }}
  resources: {{- toYaml . | nindent 4}}
  {{- end }}
  {{- with $agent.env }}
  env: {{- toYaml . | nindent 4}}
  {{- end }}
  {{- with $.Values.tolerations }}
  tolerations: {{- toYaml . | nindent 4}}
  {{- end }}
---
{{- end }}
{{- end }}